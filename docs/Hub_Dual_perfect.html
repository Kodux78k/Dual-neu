<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<link rel="manifest" href="./manifest.json"/>
<title>Hub Dual — Nebula Pro (PERFECT)</title>
<style>
  /* ================= Nebula Pro — PERFECT ================= */
  :root{
    --grad-a:#ff52e5; --grad-b:#00c5e5;
    --text:#f5f7ff; --muted:rgba(245,247,255,.7);
    --surface:rgba(15,17,32,.45); --surface-strong:rgba(15,17,32,.88);
    --border:1px solid rgba(255,255,255,.1);
    --r:24px; --r-lg:28px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{ box-sizing:border-box; min-width:0 }
  html,body{ height:100%; margin:0 }
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:linear-gradient(42deg,var(--grad-a),var(--grad-b)) fixed;
    color:var(--text);
    overflow-x:hidden; overscroll-behavior-y:contain;
    -webkit-text-size-adjust:100%;
  }

  /* ===== Masthead ===== */
  .masthead{
    position:fixed; inset:env(safe-area-inset-top,0) 0 auto 0; height:78px;
    padding:0 16px; display:flex; align-items:center; gap:12px;
    justify-content:space-between; backdrop-filter:blur(16px) saturate(120%);
    z-index:100;
  }
  .title-block{ text-align:center; flex:1; line-height:1.1; min-width:0 }
  .title-block h1{ margin:0; font-size:22px; font-weight:900; letter-spacing:.06em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .title-block small{ display:block; font-size:12px; letter-spacing:.08em; color:var(--muted) }
  .icon-btn{
    width:42px; height:42px; border-radius:50%; display:grid; place-items:center;
    background:var(--surface); border:var(--border); box-shadow:var(--shadow);
    color:var(--text); cursor:pointer; flex:0 0 auto; transition:background .15s ease;
  }
  .icon-btn:active{ transform:scale(.96) } .icon-btn:hover{ background:rgba(255,255,255,.08) }

  /* ===== Brain menu ===== */
  .brain-menu{
    position:absolute; top:calc(100% + 6px); right:8px; width:min(92vw, 360px);
    padding:12px; background:var(--surface-strong); border:var(--border);
    border-radius:var(--r-lg); box-shadow:var(--shadow); display:none; z-index:99
  }
  .brain-menu.open{ display:block; animation:appear .18s ease-out forwards }
  @keyframes appear{ from{ opacity:0; transform:translateY(-8px) } to{ opacity:1; transform:none } }
  .brain-menu h3{ margin:4px 0 10px; font-size:16px; font-weight:800; letter-spacing:.05em }
  .brain-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px }
  .brain-item{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:18px; background:rgba(255,255,255,.05); border:var(--border); }
  .brain-item svg{ width:22px; height:22px; flex-shrink:0 }
  .brain-item span{ flex:1; font-weight:700; font-size:14px }
  .brain-item small{ font-size:12px; color:var(--muted) }
  .brain-item select, .brain-item input{
    background:rgba(255,255,255,.06); color:var(--text); border:var(--border);
    border-radius:10px; padding:6px 8px; font-weight:700;
  }

  /* ===== Main ===== */
  main{
    padding-top:calc(78px + env(safe-area-inset-top,0) + 12px);
    padding-bottom:calc(80px + env(safe-area-inset-bottom,0) + 16px);
    width:100%; max-width:520px; margin:0 auto; position:relative; min-height:100vh;
  }
  section{ display:none } section.active{ display:block }
  .home-list{ display:flex; flex-direction:column; gap:14px; margin:0 16px }
  .home-item{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--surface); border:var(--border); border-radius:var(--r); box-shadow:var(--shadow); cursor:pointer }
  .home-item .left{ display:flex; align-items:center; gap:14px }
  .home-item .name{ font-weight:800; font-size:16px }
  .home-item .right{ display:flex; align-items:center; gap:6px }
  .bubble{ font-size:12px; background:#a66fff; color:#fff; border-radius:999px; padding:3px 8px; font-weight:800 }

  /* ===== Apps Grid ===== */
  .apps-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(90px,1fr)); gap:14px; padding:0 16px }
  .app-icon{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
    background:var(--surface); border:var(--border); border-radius:var(--r); box-shadow:var(--shadow);
    height:100px; cursor:pointer; padding:8px; text-align:center;
  }
  .app-icon .icon{ width:32px; height:32px; display:grid; place-items:center }
  .app-icon span{ font-size:12px; font-weight:700; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }

  /* ===== Stack ===== */
  .stack-list{ display:flex; flex-direction:column; gap:16px; padding:0 16px }
  .stack-card{ position:relative; background:var(--surface); border:var(--border); border-radius:var(--r); box-shadow:var(--shadow); padding:18px; min-height:118px }
  .stack-card h2{ margin:0 0 4px; font-size:18px; font-weight:900; padding-right:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .stack-card .tools{ position:absolute; top:14px; right:14px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end }
  .stack-card .tools .icon-btn{ width:36px; height:36px; border-radius:12px; box-shadow:none }
  .stack-card .badge{ position:absolute; right:14px; bottom:14px; font-size:12px; padding:4px 10px; border-radius:999px; background:rgba(166,111,255,.8); border:var(--border) }

  .update-section{ margin:24px 16px; text-align:center }
  .update-btn{ display:inline-block; padding:12px 32px; border-radius:var(--r); background:linear-gradient(90deg,#a66fff,#6db4ff); border:none; box-shadow:var(--shadow); color:#0a0d1f; font-weight:900; font-size:14px; cursor:pointer; transition:transform .1s ease }
  .update-btn:active{ transform:scale(.97) }

  /* ===== Viewer embutido ===== */
  .viewer{ position:fixed; inset:78px 0 88px 0; z-index:90; display:none }
  .viewer.open{ display:block }
  .viewer .frame{ position:absolute; inset:12px 16px; border-radius:18px; border:var(--border); background:var(--surface-strong); box-shadow:var(--shadow); overflow:hidden }
  .viewer .title{ position:absolute; top:18px; left:24px; right:140px; font-size:14px; font-weight:900; letter-spacing:.04em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .viewer .toolbar{ position:absolute; top:12px; right:12px; display:flex; gap:8px; flex-wrap:wrap }
  .viewer iframe{ position:absolute; inset:54px 0 0 0; width:100%; height:calc(100% - 54px); border:0; background:#0a0d1f }
  .toggle{ display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,.06); border:var(--border); border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer }
  .toggle input{ appearance:none; width:36px; height:20px; border-radius:999px; background:#444a; position:relative; outline:none; transition:all .15s }
  .toggle input::after{ content:""; position:absolute; top:2px; left:2px; width:16px; height:16px; border-radius:50%; background:#fff; transition:left .15s }
  .toggle input:checked{ background:#7fd } .toggle input:checked::after{ left:18px }

  /* ===== Quick actions ===== */
  .quick-actions{ position:fixed; bottom:calc(env(safe-area-inset-bottom,0) + 86px); right:16px; display:flex; gap:12px; z-index:95 }
  .quick-actions .small-btn{
    width:44px; height:44px; border-radius:50%; display:grid; place-items:center;
    background:var(--surface); border:var(--border); box-shadow:var(--shadow);
    cursor:pointer; transition:background .15s ease;
  }
  .quick-actions .small-btn:hover{ background:rgba(255,255,255,.08) }

  /* ===== Tabbar ===== */
  .tabbar{ position:fixed; inset:auto 0 env(safe-area-inset-bottom,0) 0; height:78px; padding:6px 14px; display:flex; align-items:center; justify-content:center; z-index:100 }
  .tabbar .container{ width:100%; max-width:520px; background:var(--surface); border:var(--border); border-radius:var(--r-lg); box-shadow:var(--shadow); display:flex; justify-content:space-around; align-items:center; padding:10px 16px }
  .tab{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; color:var(--muted); font-size:11px; font-weight:800; cursor:pointer; padding:6px; border-radius:14px; transition:background .15s ease,color .15s ease }
  .tab.active{ color:var(--text); background:rgba(255,255,255,.08); box-shadow:0 0 0 2px rgba(255,255,255,.08) }
  .tab svg{ width:22px; height:22px }

  /* iOS 100vh fix */
  @supports (-webkit-touch-callout:none){
    main, .viewer{ min-height:-webkit-fill-available }
  }
</style>
</head>
<body>
<header class="masthead">
  <button class="icon-btn" id="backBtn" aria-label="Voltar">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
  </button>
  <div class="title-block">
    <h1>HUB DUAL</h1>
    <small>UNO • DUAL • TRINITY</small>
  </div>
  <button class="icon-btn" id="brainBtn" aria-haspopup="true" aria-expanded="false" aria-label="Dual Brain">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
  </button>

  <!-- Brain menu -->
  <div class="brain-menu" id="brainMenu">
    <h3>Brain</h3>
    <ul class="brain-list">
      <li class="brain-item" id="brainDownload">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>Download (backup)</span>
      </li>
      <li class="brain-item" id="brainSK">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2"/><path d="M7.5 13.5L2 19v3h3l5.5-5.5"/><circle cx="16" cy="8" r="5"/></svg>
        <span>SK OpenRouter</span><small id="skHint"></small>
      </li>
      <li class="brain-item" style="cursor:default">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v6H3z"/><path d="M3 15h18v6H3z"/></svg>
        <span>Modelo</span>
        <select id="modelSelect"></select>
      </li>
      <li class="brain-item" id="brainLogs">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18"/><path d="M3 8h18"/><path d="M3 13h18"/><path d="M3 18h18"/></svg>
        <span>Limpar logs</span>
      </li>
    </ul>
  </div>
</header>

<!-- Ações rápidas -->
<div class="quick-actions">
  <button class="small-btn" onclick="toast('Atalho 1')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
  </button>
  <button class="small-btn" onclick="toast('Atalho 2')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3H7a4 4 0 0 0-4 4v10a4 4 0 0 0 4 4h10a4 4 0 0 0 4-4V7a4 4 0 0 0-4-4z"/><line x1="7" y1="7" x2="17" y2="17"/><line x1="17" y1="7" x2="7" y2="17"/></svg>
  </button>
</div>

<main>
  <section id="page-home" class="active">
    <div class="home-list">
      <div class="home-item" onclick="go('apps')">
        <div class="left">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg>
          <span class="name">Apps</span>
        </div>
        <div class="right">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>
      <div class="home-item" onclick="go('stack')">
        <div class="left">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l9 4.5-9 4.5L3 6.5 12 2z"/><path d="M3 13l9 4.5 9-4.5"/></svg>
          <span class="name">Stack</span>
        </div>
        <div class="right">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>
      <div class="home-item" onclick="go('stack')">
        <div class="left">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18"/></svg>
          <span class="name">Minimized</span>
        </div>
        <div class="right">
          <span class="bubble" id="miniCountHome">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </div>
    </div>
  </section>

  <!-- Apps -->
  <section id="page-apps">
    <div class="apps-grid" id="appsGrid"></div>
  </section>

  <!-- Stack -->
  <section id="page-stack">
    <div class="stack-list" id="stackList"></div>
    <div class="update-section">
      <button class="update-btn" onclick="toast('Update')">Update</button>
    </div>
  </section>
</main>

<!-- Viewer embutido -->
<div class="viewer" id="viewer">
  <div class="frame">
    <div class="title"><span id="viewerTitle">—</span></div>
    <div class="toolbar">
      <label class="toggle" title="Abrir em nova aba / dentro (por app)">
        <input type="checkbox" id="openModeToggle"/>
        <span id="openModeLabel">Dentro</span>
      </label>
      <button class="icon-btn" title="Minimizar" id="viewerMinBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
      </button>
      <button class="icon-btn" title="Recarregar" id="viewerReloadBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10M1 14l5.36 4.36A9 9 0 0 0 20.49 15"/></svg>
      </button>
      <button class="icon-btn" title="Fechar" id="viewerCloseBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <iframe id="viewerFrame" src="about:blank" referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<footer class="tabbar">
  <div class="container">
    <div class="tab" id="tab-home" onclick="go('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
      <span>Home</span>
    </div>
    <div class="tab" id="tab-apps" onclick="go('apps')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg>
      <span>Apps</span>
    </div>
    <div class="tab" id="tab-stack" onclick="go('stack')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l9 4.5-9 4.5L3 6.5 12 2z"/><path d="M3 13l9 4.5 9-4.5"/></svg>
      <span>Stack</span>
    </div>
  </div>
</footer>

<script>
/* ================= Helpers ================= */
const LS = {
  get(k, d){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : d }catch(e){ return d } },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
  raw(k){ return localStorage.getItem(k)||'' }
};
function toast(m){ console.log(m) }
function exportBackup(){
  const data = { when: Date.now(), storage: {...localStorage} };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'dual.backup.json'; a.click(); URL.revokeObjectURL(url);
  toast('Backup exportado');
}
function promptKey(){
  const key = prompt('Cole sua SK do OpenRouter (salva localmente):', LS.raw('dual.keys.openrouter'));
  if(key!=null){ localStorage.setItem('dual.keys.openrouter', key); document.getElementById('skHint').textContent = key ? '• OK' : '' ; toast('Chave armazenada') }
}
function clearLogs(){ console.clear(); toast('Logs limpos') }

/* ================= Navegação ================= */
function go(target){
  brainMenu.classList.remove('open'); brainBtn.setAttribute('aria-expanded','false');
  ['home','apps','stack'].forEach(p=>{
    const sec = document.getElementById('page-'+p); if(sec) sec.classList.remove('active');
    const tab = document.getElementById('tab-'+p); if(tab) tab.classList.remove('active');
  });
  const newSec = document.getElementById('page-'+target); if(newSec) newSec.classList.add('active');
  const newTab = document.getElementById('tab-'+target); if(newTab) newTab.classList.add('active');
}
const brainBtn = document.getElementById('brainBtn');
const brainMenu = document.getElementById('brainMenu');
brainBtn.addEventListener('click', (e)=>{
  const isOpen = brainMenu.classList.toggle('open');
  brainBtn.setAttribute('aria-expanded', String(isOpen)); e.stopPropagation();
});
document.addEventListener('click', (e)=>{
  if(!brainMenu.contains(e.target) && e.target !== brainBtn){
    brainMenu.classList.remove('open'); brainBtn.setAttribute('aria-expanded','false');
  }
});
document.getElementById('backBtn').addEventListener('click', ()=>history.back());

/* ================= Modelo (OpenRouter) ================= */
const DEFAULT_MODELS = [
  "openrouter/auto",
  "anthropic/claude-3.5-sonnet",
  "openai/gpt-4.1-mini",
  "google/gemini-1.5-pro",
  "meta/llama-3.1-405b-instruct",
  "mistral/mistral-large-latest"
];
const modelSelect = document.getElementById('modelSelect');
function initModelSelect(){
  const saved = LS.get('dual.openrouter.model', DEFAULT_MODELS[0]);
  modelSelect.innerHTML = "";
  DEFAULT_MODELS.forEach(m=>{
    const opt = document.createElement('option'); opt.value = m; opt.textContent = m; if(m===saved) opt.selected = true;
    modelSelect.appendChild(opt);
  });
  modelSelect.addEventListener('change', ()=>{ LS.set('dual.openrouter.model', modelSelect.value); toast('Modelo: '+modelSelect.value) });
}

/* ================= Ícones dinâmicos ================= */
const iconCache = new Map();
function normKey(s){
  return (s||'').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-z0-9_-]+/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,'');
}
async function getIconNode(app){
  // Priority: explicit bitmap/icon path -> iconKey svg -> computed key svg -> fallback
  if(app.icon && /\\.(png|jpg|jpeg|gif|webp|svg)$/i.test(app.icon)){
    const d = document.createElement('div'); d.className='icon';
    const img = new Image(); img.src = app.icon; img.alt = app.name||app.title||app.id||'app';
    img.style.width = '26px'; img.style.height = '26px';
    d.appendChild(img); return d;
  }
  const key = normKey(app.iconKey || app.key || app.id || app.title || app.name || 'app');
  const path = `./icons/others/${key}.svg`;
  try{
    const cacheKey = 'svg:'+path;
    if(iconCache.has(cacheKey)){ const d=document.createElement('div'); d.className='icon'; d.innerHTML = iconCache.get(cacheKey); return d; }
    const res = await fetch(path, {cache:'force-cache'});
    if(res.ok){
      const svg = await res.text(); iconCache.set(cacheKey, svg);
      const d=document.createElement('div'); d.className='icon'; d.innerHTML=svg; return d;
    }
  }catch(e){}
  const d=document.createElement('div'); d.className='icon';
  d.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="4"/></svg>';
  return d;
}

/* ================= Apps ================= */
const appsGrid = document.getElementById('appsGrid');
async function readApps(){
  // Supports two formats:
  // 1) Array of apps: [ {id,name,url,iconKey,defaultOpenMode} ]
  // 2) { groups: { "Group Name": [ {key,title,url,iconKey,...}, ... ] } }
  try{
    const res = await fetch('./apps/apps.json', {cache:'no-cache'});
    if(!res.ok) throw new Error('missing apps.json');
    const data = await res.json();
    if(Array.isArray(data)) return data.map(x => ({
      id: x.id || x.key || normKey(x.title||x.name),
      name: x.name || x.title || x.key,
      url: x.url,
      iconKey: x.iconKey,
      icon: x.icon,
      defaultOpenMode: x.defaultOpenMode || 'embed'
    }));
    if(data && data.groups){
      const out=[];
      for(const g of Object.keys(data.groups)){
        for(const app of (data.groups[g]||[])){
          out.push({
            id: app.key || app.id || normKey(app.title||app.name),
            name: app.title || app.name || app.key,
            url: app.url,
            iconKey: app.iconKey || app.key,
            icon: app.icon,
            defaultOpenMode: app.defaultOpenMode || 'embed'
          });
        }
      }
      return out;
    }
    return [];
  }catch(e){
    // Fallback demonstrativo
    return [
      { id:'chat', name:'Chat', url:'chat.html', iconKey:'hub_chat', defaultOpenMode:'embed' },
      { id:'editor', name:'Editor', url:'editor.html', iconKey:'hub_config', defaultOpenMode:'embed' },
      { id:'books', name:'Books', url:'books.html', iconKey:'hub_relatorio', defaultOpenMode:'embed' },
      { id:'koblox', name:'KOBLOX', url:'player.html', iconKey:'hub_health', defaultOpenMode:'embed' }
    ];
  }
}

/* per-app openMode */
function getOpenMode(appId, def){ return LS.get('dual.app.openMode.'+appId, def||'embed') }
function setOpenMode(appId, mode){ LS.set('dual.app.openMode.'+appId, mode) }

/* ================= Viewer + Stack ================= */
const viewer = document.getElementById('viewer');
const viewerFrame = document.getElementById('viewerFrame');
const viewerTitle = document.getElementById('viewerTitle');
const openModeToggle = document.getElementById('openModeToggle');
const openModeLabel = document.getElementById('openModeLabel');
const viewerMinBtn = document.getElementById('viewerMinBtn');
const viewerReloadBtn = document.getElementById('viewerReloadBtn');
const viewerCloseBtn = document.getElementById('viewerCloseBtn');
let currentAppId = null;

function readStack(){ return LS.get('dual.stack', []) }
function writeStack(v){ LS.set('dual.stack', v) }
function addToStack(app, opts={}){
  const st = readStack();
  const i = st.findIndex(s=>s.id===app.id);
  const item = { id:app.id, title:app.name, url:app.url, minimized:!!opts.minimized, mode:opts.mode||'embed', t:Date.now() };
  if(i>=0){ st[i] = item } else { st.unshift(item) }
  writeStack(st); renderStack();
}
function removeFromStack(id){ writeStack(readStack().filter(s=>s.id!==id)); renderStack() }
function setMinimized(id,val){
  const st = readStack(); const i = st.findIndex(s=>s.id===id);
  if(i>=0){ st[i].minimized = !!val; writeStack(st); renderStack() }
}
function setStackMode(id, mode){
  const st = readStack(); const i = st.findIndex(s=>s.id===id);
  if(i>=0){ st[i].mode = mode; writeStack(st); renderStack() }
}

const stackList = document.getElementById('stackList');
function renderStack(){
  const st = readStack();
  const miniCount = st.filter(s=>s.minimized).length;
  document.getElementById('miniCountHome').textContent = miniCount;
  stackList.innerHTML = '';
  st.forEach(s=>{
    const card = document.createElement('div'); card.className='stack-card';
    const h2 = document.createElement('h2'); h2.textContent = s.title; card.appendChild(h2);

    const tools = document.createElement('div'); tools.className='tools';
    // toggle open mode (também no stack)
    const toggleWrap = document.createElement('label'); toggleWrap.className='toggle'; toggleWrap.title='Abrir em nova aba / dentro';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = (getOpenMode(s.id, 'embed')==='tab');
    const span = document.createElement('span'); span.textContent = chk.checked ? 'Nova aba' : 'Dentro';
    chk.addEventListener('change', ()=>{ const m = chk.checked?'tab':'embed'; setOpenMode(s.id,m); setStackMode(s.id,m); span.textContent = chk.checked?'Nova aba':'Dentro' });
    toggleWrap.appendChild(chk); toggleWrap.appendChild(span);
    tools.appendChild(toggleWrap);

    const btnMin = document.createElement('button'); btnMin.className='icon-btn'; btnMin.title='Minimizar';
    btnMin.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>`;
    btnMin.onclick = ()=>setMinimized(s.id,true);

    const btnOpen = document.createElement('button'); btnOpen.className='icon-btn'; btnOpen.title='Abrir';
    btnOpen.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>`;
    btnOpen.onclick = ()=>{
      if(getOpenMode(s.id,'embed')==='tab'){ window.open(s.url,'_blank','noopener,noreferrer') }
      else { viewerTitle.textContent = s.title; viewerFrame.src = s.url; viewer.classList.add('open'); setMinimized(s.id,false) }
    };

    const btnReload = document.createElement('button'); btnReload.className='icon-btn'; btnReload.title='Recarregar';
    btnReload.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10M1 14l5.36 4.36A9 9 0 0 0 20.49 15"/></svg>`;
    btnReload.onclick = ()=>{ try{ viewerFrame.contentWindow.location.reload() }catch(e){ viewerFrame.src = viewerFrame.src } };

    const btnClose = document.createElement('button'); btnClose.className='icon-btn'; btnClose.title='Fechar';
    btnClose.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
    btnClose.onclick = ()=>removeFromStack(s.id);

    tools.appendChild(btnMin); tools.appendChild(btnOpen); tools.appendChild(btnReload); tools.appendChild(btnClose);
    card.appendChild(tools);

    if(s.minimized){ const b=document.createElement('div'); b.className='badge'; b.textContent='Minimized'; card.appendChild(b) }
    stackList.appendChild(card);
  });
}

/* ================= Render Apps ================= */
async function renderApps(){
  const apps = await readApps();
  appsGrid.innerHTML = '';
  for(const app of apps){
    const tile = document.createElement('div'); tile.className='app-icon';
    const iconNode = await getIconNode(app); iconNode.classList.add('icon');
    const label = document.createElement('span'); label.textContent = app.name;
    tile.appendChild(iconNode); tile.appendChild(label);
    tile.onclick = ()=>openApp(app);
    appsGrid.appendChild(tile);
    if(LS.get('dual.app.openMode.'+app.id, null)===null){ setOpenMode(app.id, app.defaultOpenMode||'embed') }
  }
}

/* ================= Open App ================= */
function openApp(app){
  const mode = getOpenMode(app.id, app.defaultOpenMode||'embed');
  if(mode==='tab'){
    window.open(app.url,'_blank','noopener,noreferrer');
    addToStack(app,{ minimized:false, mode:'tab' });
    return;
  }
  viewerTitle.textContent = app.name;
  viewer.classList.add('open');
  viewerFrame.src = app.url;
  currentAppId = app.id;
  openModeToggle.checked = (mode==='tab');
  openModeLabel.textContent = openModeToggle.checked ? 'Nova aba' : 'Dentro';
  addToStack(app,{ minimized:false, mode:'embed' });
}
openModeToggle.addEventListener('change', ()=>{
  if(!currentAppId) return;
  const m = openModeToggle.checked ? 'tab' : 'embed';
  setOpenMode(currentAppId, m);
  setStackMode(currentAppId, m);
  openModeLabel.textContent = openModeToggle.checked ? 'Nova aba' : 'Dentro';
});
viewerMinBtn.addEventListener('click', ()=>{ viewer.classList.remove('open'); if(currentAppId){ setMinimized(currentAppId,true) } });
viewerReloadBtn.addEventListener('click', ()=>{ try{ viewerFrame.contentWindow.location.reload() }catch(e){ viewerFrame.src = viewerFrame.src } });
viewerCloseBtn.addEventListener('click', ()=>{ viewer.classList.remove('open'); viewerFrame.src='about:blank'; if(currentAppId){ removeFromStack(currentAppId); currentAppId=null } });

/* ================= Boot ================= */
function boot(){
  document.getElementById('skHint').textContent = LS.raw('dual.keys.openrouter') ? '• OK' : '';
  document.getElementById('brainDownload').onclick = exportBackup;
  document.getElementById('brainSK').onclick = promptKey;
  document.getElementById('brainLogs').onclick = clearLogs;
  initModelSelect();
  renderApps();
  renderStack();
  if('serviceWorker' in navigator){ try{ navigator.serviceWorker.register('./service-worker.js') }catch(e){} }
}
boot();
</script>
</body>
</html>
