<!doctype html><html lang="pt-BR"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no"><meta name="theme-color" content="#0b0f14">
  <link rel="manifest" href="./manifest.json"><title>HUB üë• UNO</title>
<style>
:root{--a:#ff52e5;--b:#00c5e5;--fg:#eaf0ff;--mut:#b8c0d9;--bd:#ffffff22;--glass:#0b112280;--r:14px;--tabs:64px;--hdr:56px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;color:var(--fg);background:linear-gradient(42deg,var(--a),var(--b)) fixed;font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
header{position:fixed;inset:0 0 auto;display:flex;align-items:center;gap:8px;height:var(--hdr);padding:0 10px;background:linear-gradient(180deg,#0009,#0000);backdrop-filter:blur(10px);z-index:10}
h1{margin:0;font:900 16px/1 Inter,system-ui;letter-spacing:.06em}small{color:var(--mut)}
.ib{min-width:38px;height:38px;border:1px solid var(--bd);border-radius:12px;background:#0c1330aa;color:var(--fg);display:grid;place-items:center;cursor:pointer}
main{position:relative;height:100%;padding:calc(var(--hdr) + env(safe-area-inset-top)) 10px calc(var(--tabs) + env(safe-area-inset-bottom)) ;overflow:auto}
.view{display:none;max-width:900px;margin:0 auto} .view.active{display:block;animation:fade .15s ease}@keyframes fade{from{opacity:0;transform:translateY(6px)}}
.card{background:#0b1122cc;border:1px solid var(--bd);border-radius:16px;padding:12px;box-shadow:0 12px 32px #0007}
.grid{display:grid;gap:10px}
.tabbar{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom,0);height:var(--tabs);display:flex;justify-content:center;padding:8px;z-index:10}
.tabbar .in{width:100%;max-width:900px;display:flex;justify-content:space-around;gap:8px;background:#0b1122cc;border:1px solid var(--bd);border-radius:18px;padding:8px}
.tab{flex:1;border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--mut);cursor:pointer}
.tab.active{background:#ffffff14;color:var(--fg)}
.btn{border:1px solid var(--bd);background:#0b1122; color:var(--fg);border-radius:12px;padding:.55rem .8rem;cursor:pointer}
.input,select,textarea{width:100%;background:#0b1122;border:1px solid var(--bd);color:var(--fg);border-radius:12px;padding:8px}
.mut{color:var(--mut);font-size:12px}
#dock{position:fixed;left:10px;right:10px;bottom:calc(var(--tabs)+10px + env(safe-area-inset-bottom));display:flex;gap:8px;flex-wrap:wrap;z-index:9}
.badge{border:1px solid var(--bd);border-radius:999px;background:#0b1122;padding:.35rem .6rem;font-weight:800}
.arch{margin-top:6vh;display:grid;place-items:center;gap:10px}
.circle{position:relative;width:min(80vw,480px);aspect-ratio:1/1;border-radius:50%;overflow:hidden;border:1px solid var(--bd);background:radial-gradient(60% 60% at 50% 50%,#0ff2,#fff0)}
.circle iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:transparent}
.msg{position:relative;margin-top:6px;background:#0b1122; border:1px solid var(--bd);border-radius:12px;padding:8px 10px;max-width:92%;text-align:center;opacity:.96}
.switch{display:flex;gap:6px;align-items:center;background:#0b1122aa;border:1px solid var(--bd);border-radius:999px;padding:4px 8px}
.switch button{width:30px;height:30px;border-radius:8px}
#chatFeed{min-height:140px;max-height:50vh;overflow:auto;background:#0b1122cc;border:1px solid var(--bd);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:6px}
#chatFeed .m{max-width:75%;padding:7px 10px;border-radius:14px}
#chatFeed .u{align-self:flex-end;background:#ffffff14;border-radius:14px 14px 0 14px}
#chatFeed .a{align-self:flex-start;background:#00ffaa22;border-radius:14px 14px 14px 0}
.homeBtns{position:fixed;right:12px;bottom:calc(var(--tabs)+20px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:8px;z-index:9}
.hb{width:44px;height:44px;border-radius:22px;border:1px solid var(--bd);background:#0b1122;display:grid;place-items:center;font-size:18px}
#preview{position:fixed;left:12px;right:12px;bottom:calc(var(--tabs)+20px + env(safe-area-inset-bottom));background:#ffb86b;color:#0b0f14;border-radius:14px;padding:8px 12px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:9;display:none}
.apps{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
.app{display:flex;gap:10px;align-items:center;background:#ffffff0e;border:1px solid var(--bd);border-radius:12px;padding:12px}
.app .ico{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:#0b1122;border:1px solid var(--bd)}
.app .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.session{background:#ffffff06;border:1px solid var(--bd);border-radius:14px;overflow:hidden}
.session .h{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#ffffff08;border-bottom:1px solid #ffffff16}
.session iframe{display:block;width:100%;height:58vh;border:0;background:#000}
.toast{position:fixed;right:12px;bottom:calc(var(--tabs)+14px);display:grid;gap:8px;z-index:20}
.toast .t{background:#0f2a1e;border:1px solid #2f7a56;color:#c9ffe7;padding:.55rem .7rem;border-radius:10px}
.theme-custom-bg{position:fixed;inset:0;z-index:-1;overflow:hidden;pointer-events:none}
</style>
</head><body>
<header>
  <button class="ib" id="btnBack">‚üµ</button>
  <div style="flex:1;text-align:center"><h1>HUB UNO</h1><small>Dual ¬∑ Trinity</small></div>
  <button class="ib" id="btnDownload" title="Baixar">‚¨áÔ∏è</button>
  <button class="ib" id="btnHelp" title="Ajuda">‚ùî</button>
  <button class="ib" id="btnLS" title="LocalStorage">LS</button>
</header>

<main>
  <!-- HOME -->
  <section id="v-home" class="view active">
    <div class="grid">
      <div class="arch">
        <div class="switch">
          <button class="btn" id="archPrev">‚Äπ</button>
          <select id="archSel" title="Arqu√©tipo"></select>
          <button class="btn" id="archNext">‚Ä∫</button>
          <button class="btn" id="archAudio" title="Voz">üéôÔ∏è</button>
        </div>
        <div class="circle" id="archCircle"><iframe id="archFrame" title="Archetype" sandbox="allow-scripts allow-same-origin"></iframe></div>
        <div id="archMsg" class="msg" style="display:none"></div>
      </div>
      <div id="iaFeed" class="card" style="display:none"></div>
    </div>
  </section>

  <!-- APPS -->
  <section id="v-apps" class="view">
    <div class="grid">
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <label class="mut" style="display:inline-flex;gap:6px;align-items:center"><input id="openInside" type="checkbox"> abrir dentro</label>
          <button id="toggleLocal" class="btn">Mostrar Locais</button>
          <input id="fileLocal" type="file" accept=".html,.htm,.txt,.json" multiple class="input" style="max-width:280px">
          <button id="importLocal" class="btn">Adicionar</button>
          <button id="exportLocal" class="btn">Exportar</button>
          <button id="clearLocal" class="btn">Limpar</button>
          <span id="appsCount" class="mut">‚Äî</span>
        </div>
      </div>
      <div id="appsWrap" class="apps"></div>
    </div>
  </section>

  <!-- STACK -->
  <section id="v-stack" class="view">
    <div class="grid">
      <div class="card" style="display:flex;align-items:center;gap:8px"><b>Sess√µes</b><button id="closeAll" class="btn">Fechar todas</button><span class="mut">Reabra pelo dock</span></div>
      <div id="stackWrap" class="grid"></div>
    </div>
  </section>

  <!-- BRAIN -->
  <section id="v-brain" class="view">
    <div class="grid">
      <div class="card"><b>Usu√°rio</b>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px"><input id="userName" class="input" placeholder="Seu nome" style="max-width:220px"><button id="saveName" class="btn">Salvar</button></div>
      </div>
      <div class="card"><b>OpenRouter</b>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
          <select id="model" class="input" style="max-width:280px"></select>
          <input id="sk" class="input" placeholder="sk-or-v1-‚Ä¶" style="max-width:260px">
          <button id="saveSK" class="btn">Salvar</button>
        </div>
      </div>
      <div class="card"><b>Tema & Fundo</b>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <select id="themeSel" class="input" style="max-width:200px">
            <option value="default">Padr√£o</option><option value="medium">Cinza</option><option value="custom">Personalizado</option>
          </select>
          <input id="bgUpload" type="file" accept="image/*,video/*" class="input" style="max-width:260px">
        </div>
      </div>
      <div class="card"><b>CSS Personalizado</b>
        <textarea id="cssCustom" class="input" rows="4" placeholder="/* cole CSS aqui */"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <button id="applyCSS" class="btn">Aplicar</button>
          <button id="clearCSS" class="btn">Limpar</button>
          <button id="downloadCSS" class="btn">Baixar</button>
        </div>
      </div>
      <div class="card"><b>LS ‚Ä¢ r√°pido</b>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <input id="lsK" class="input" placeholder="chave (ex: infodose:userName)" style="flex:1 1 220px">
          <input id="lsV" class="input" placeholder="valor" style="flex:2 1 320px">
          <button id="lsSave" class="btn">Salvar</button>
          <button id="lsDel" class="btn">Apagar</button>
        </div>
        <div class="mut" id="lsStat" style="margin-top:6px">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="v-chat" class="view">
    <div class="grid">
      <div id="chatFeed"></div>
      <form id="chatForm" style="display:flex;gap:8px"><input id="chatInput" class="input" placeholder="Escreva aqui‚Ä¶" autocomplete="off"><button class="btn" id="chatSend">Enviar</button></form>
    </div>
  </section>
</main>

<div id="dock"></div>
<nav class="tabbar"><div class="in">
  <button class="tab active" data-nav="home">üè†<span class="mut">Home</span></button>
  <button class="tab" data-nav="apps">üìÅ<span class="mut">Apps</span></button>
  <button class="tab" data-nav="stack">üß±<span class="mut">Stack</span></button>
  <button class="tab" data-nav="brain">üß†<span class="mut">Brain</span></button>
  <button class="tab" data-nav="chat">üí¨<span class="mut">Chat</span></button>
</div></nav>

<div id="preview"></div>
<div class="homeBtns">
  <button id="btnVoice" class="hb" title="Falar">üé§</button>
  <button id="btnText" class="hb" title="Texto">‚úçÔ∏è</button>
</div>
<div id="toasts" class="toast"></div>
<div id="customBG" class="theme-custom-bg"></div>

<script id="APPS_JSON" type="application/json">{"apps":[
{"key":"atlas","title":"Atlas ¬∑ Cartesius","desc":"Planejador","url":"about:blank","icon":""},
{"key":"nova","title":"Nova ¬∑ Inspira","desc":"Criativa","url":"about:blank","icon":""},
{"key":"vitalis","title":"Vitalis ¬∑ Momentum","desc":"Rotinas","url":"about:blank","icon":""},
{"key":"pulse","title":"Pulse ¬∑ Resona","desc":"Som","url":"about:blank","icon":""},
{"key":"aion","title":"Aion ¬∑ Evolutia","desc":"Evolu√ß√£o","url":"about:blank","icon":""}
]}</script>

<script>
const $=(q,r=document)=>r.querySelector(q), $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const LS={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},raw:k=>localStorage.getItem(k)||''};
const toast=(m,t='ok')=>{const b=$("#toasts"),d=document.createElement('div');d.className='t';d.style.background=t==='err'?'#3c1212':(t==='warn'?'#3c2d12':'#0f2a1e');d.textContent=m;b.appendChild(d);setTimeout(()=>{d.style.opacity=.0;d.style.transform='translateY(6px)';setTimeout(()=>d.remove(),180)},1500)};

// NAV
function nav(key){['home','apps','stack','brain','chat'].forEach(k=>{ $('#v-'+k).classList.toggle('active',k===key); document.querySelector('.tab[data-nav="'+k+'"]').classList.toggle('active',k===key)}); LS.set('uno:lastTab',key); if(key==='home') greeting(); $("#preview").style.display= key==='home' && $("#preview").textContent? 'block':'none'}
$$('.tab').forEach(b=>b.onclick=()=>nav(b.dataset.nav));

// GREETING
function greeting(){const n=(localStorage.getItem('infodose:userName')||'').trim(); msgArch(n?`Bem-vindo, ${n}.`:'Salve! Defina seu nome no Brain.', n?'ok':'warn')}

// THEME + BG
function applyTheme(){const t=LS.get('uno:theme','medium'); if(t==='default') delete document.body.dataset.theme; else document.body.dataset.theme=t;
const bg=$("#customBG"); bg.innerHTML=''; if(t!=='custom') return; const data=LS.get('uno:bg',''); if(!data) return; const v=/^data:video\//.test(data); const el=document.createElement(v?'video':'img'); el.src=data; if(v){el.autoplay=el.loop=el.muted=true; el.playsInline=true} Object.assign(el.style,{width:'100%',height:'100%',objectFit:'cover'}); bg.appendChild(el)}
$("#themeSel")&&($("#themeSel").value=LS.get('uno:theme','medium'), $("#themeSel").onchange=()=>{LS.set('uno:theme',$("#themeSel").value);applyTheme();toast('Tema atualizado')});
$("#bgUpload")&&($("#bgUpload").onchange=e=>{const f=e.target.files&&e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{LS.set('uno:bg',r.result);LS.set('uno:theme','custom');$("#themeSel").value='custom';applyTheme();toast('Fundo salvo')}; r.readAsDataURL(f)});

// CSS custom
function applyCSS(){let st=$("#customStyle"); if(!st){st=document.createElement('style');st.id='customStyle';document.head.appendChild(st)} st.textContent=localStorage.getItem('infodose:cssCustom')||''}
$("#applyCSS")&&($("#applyCSS").onclick=()=>{localStorage.setItem('infodose:cssCustom',($("#cssCustom").value||''));applyCSS();toast('CSS aplicado')});
$("#clearCSS")&&($("#clearCSS").onclick=()=>{localStorage.removeItem('infodose:cssCustom');$("#cssCustom").value='';applyCSS();toast('CSS limpo','warn')});
$("#downloadCSS")&&($("#downloadCSS").onclick=()=>{const css=localStorage.getItem('infodose:cssCustom')||''; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([css],{type:'text/css'})); a.download='custom.css'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),400)});

// Brain
const MODELS=['openrouter/auto','anthropic/claude-3.5-sonnet','openai/gpt-4.1-mini','google/gemini-1.5-pro','meta/llama-3.1-405b-instruct'];
(function initBrain(){const sel=$("#model"); sel.innerHTML=''; MODELS.forEach(m=>{const o=document.createElement('option');o.value=o.textContent=m; sel.appendChild(o)}); sel.value=LS.get('dual.openrouter.model',MODELS[0]); $("#sk").value=LS.raw('dual.keys.openrouter')||'';
$("#saveSK").onclick=()=>{LS.set('dual.openrouter.model',sel.value); localStorage.setItem('dual.keys.openrouter',$("#sk").value||''); toast('Config salvo')};
$("#saveName").onclick=()=>{localStorage.setItem('infodose:userName',($("#userName").value||'').trim());toast('Nome salvo'); greeting()};
})();

// LS mini
function lsStats(){let bytes=0; try{for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i),v=localStorage.getItem(k)||''; bytes+=k.length+v.length}}catch{} const fmt=n=>n<1024? n+'B': n<1048576? (n/1024).toFixed(1)+'KB' : (n/1048576).toFixed(2)+'MB'; $("#lsStat").textContent=`chaves:${localStorage.length} ¬∑ ${fmt(bytes)}`}
$("#lsSave")&&($("#lsSave").onclick=()=>{const k=$("#lsK").value.trim(); if(!k)return; localStorage.setItem(k,$("#lsV").value||''); lsStats(); toast('LS salvo')});
$("#lsDel")&&($("#lsDel").onclick=()=>{const k=$("#lsK").value.trim(); if(!k)return; localStorage.removeItem(k); lsStats(); toast('LS apagado','warn')});

// Apps
const RAW={apps:[]}; let onlyLocal=false; const appsWrap=$("#appsWrap"), appsCount=$("#appsCount");
function normalize(L){return (L||[]).map(x=>({key:x.key||x.url||Math.random().toString(36).slice(2),title:x.title||'App',desc:x.desc||'',url:String(x.url||''),icon:x.icon||''}))}
function locals(){let arr=[]; try{arr=JSON.parse(LS.raw('infodose:locals:v1')||'[]')}catch{} return arr.map(l=>({key:'local:'+l.id,title:l.name||'Local',desc:'HTML local',url:'local:'+l.id}))}
function getLocal(id){let a=[]; try{a=JSON.parse(LS.raw('infodose:locals:v1')||'[]')}catch{} return a.find(x=>x.id===id)||null}
function blobURL(loc){return URL.createObjectURL(new Blob([loc.html||''],{type:'text/html;charset=utf-8'}))}
function card(a){const el=document.createElement('div'); el.className='app'; const ic=document.createElement('div'); ic.className='ico'; ic.textContent='üì¶'; const meta=document.createElement('div'); meta.style.flex='1'; const t=document.createElement('div'); t.className='t'; t.textContent=a.title; const d=document.createElement('div'); d.className='mut'; d.textContent=a.desc||a.url; const b=document.createElement('button'); b.className='btn'; b.textContent='Abrir'; b.onclick=()=>openApp(a); meta.append(t,d); el.append(ic,meta,b); return el}
function renderApps(){let L=normalize(RAW.apps).concat(locals()); if(onlyLocal) L=L.filter(x=>x.url.startsWith('local:')); appsWrap.innerHTML=''; L.forEach(a=>appsWrap.appendChild(card(a))); appsCount.textContent=L.length+' apps'}
(function loadApps(){try{RAW.apps=JSON.parse($("#APPS_JSON").textContent||'{}').apps||[]}catch{RAW.apps=[]} renderApps()})();
$("#toggleLocal").onclick=()=>{onlyLocal=!onlyLocal; $("#toggleLocal").textContent=onlyLocal?'Mostrar Todos':'Mostrar Locais'; renderApps()};
$("#importLocal").onclick=async()=>{const fs=Array.from($("#fileLocal").files||[]); if(!fs.length)return; const tasks=fs.map(f=>new Promise(res=>{const r=new FileReader(); r.onload=()=>{const s=String(r.result||''); if(/\.json$/i.test(f.name)){try{const o=JSON.parse(s); RAW.apps=Array.isArray(o.apps)?o.apps:Array.isArray(o)?o:[]; renderApps(); toast('apps.json carregado'); res(null)}catch{toast('JSON inv√°lido','err');res(null)}}else{res({id:'l_'+Math.random().toString(36).slice(2),name:f.name.replace(/\.(html?|txt)$/i,''),html:s,ts:Date.now()})}}; r.readAsText(f)})); const list=(await Promise.all(tasks)).filter(Boolean); const cur=JSON.parse(LS.raw('infodose:locals:v1')||'[]'); list.forEach(x=>cur.unshift(x)); localStorage.setItem('infodose:locals:v1',JSON.stringify(cur)); renderApps(); if(list.length) toast('HTMLs adicionados')};
$("#exportLocal").onclick=()=>{const data={v:1,items:JSON.parse(LS.raw('infodose:locals:v1')||'[]')}; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download='locals_pack.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),400)};
$("#clearLocal").onclick=()=>{if(confirm('Limpar HTMLs locais?')){localStorage.removeItem('infodose:locals:v1'); renderApps(); toast('Locais limpos','warn')}};

// Stack + Dock
const stackWrap=$("#stackWrap"), dock=$("#dock");
function badge(it){const b=document.createElement('button'); b.className='badge'; b.textContent=it.title; b.onclick=()=>{const s=document.querySelector('[data-sid="'+it.sid+'"]'); if(s){s.scrollIntoView({behavior:'smooth'}); s.classList.remove('min')}}; return b}
function updDock(){dock.innerHTML=''; $$('.session').forEach(s=>{const meta=JSON.parse(s.dataset.meta||'{}'); dock.appendChild(badge({title:meta.title||'App',sid:s.dataset.sid}))})}
function openApp(a){const sid='s_'+Math.random().toString(36).slice(2); const isLocal=a.url.startsWith('local:'); const lr=isLocal?getLocal(a.url.slice(6)):null; const url=lr?blobURL(lr):a.url||'about:blank';
const card=document.createElement('div'); card.className='session'; card.dataset.sid=sid; card.dataset.meta=JSON.stringify({title:a.title||'App',url:a.url||''});
card.innerHTML=`<div class="h"><b style="flex:1">${a.title||'App'}</b><button class="btn" data-act="min">‚Äì</button><button class="btn" data-act="ref">‚Üª</button><button class="btn" data-act="x">‚úï</button></div><iframe src="${url}" allow="autoplay;clipboard-read;clipboard-write;picture-in-picture;fullscreen"></iframe>`;
($("#openInside").checked? $("#v-home") : $("#v-stack")).querySelector ? $("#v-stack").prepend(card) : stackWrap.prepend(card);
card.querySelector('[data-act=min]').onclick=()=>{card.classList.toggle('min'); card.querySelector('iframe').style.display=card.classList.contains('min')?'none':'block'; updDock()};
card.querySelector('[data-act=ref]').onclick=()=>{const fr=card.querySelector('iframe'); try{fr.contentWindow.location.reload()}catch{fr.src=fr.src}};
card.querySelector('[data-act=x]').onclick=()=>{card.remove(); updDock()}; nav('stack'); updDock(); toast('App aberto')}
$("#closeAll").onclick=()=>{if(!confirm('Fechar todas as sess√µes?'))return; $$('.session').forEach(s=>s.remove()); updDock(); toast('Sess√µes fechadas','warn')};

// Archetypes
const ARCH=['luxara.html','rhea.html','aion.html','atlas.html','nova.html','genus.html','horus.html'];
const archSel=$("#archSel"), archFrame=$("#archFrame"), archMsg=$("#archMsg");
function fillArch(){archSel.innerHTML=''; ARCH.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n.replace('.html',''); archSel.appendChild(o)}); setArch(0)}
function setArch(i){const n=(i+ARCH.length)%ARCH.length; archSel.selectedIndex=n; const f=ARCH[n]; archFrame.src='./archetypes/'+f; speakArch(f.replace('.html',''))}
function speakArch(name){try{const vs=speechSynthesis.getVoices(); const v=vs.find(v=>v.lang&&v.lang.startsWith('pt'))||vs[0]; const u=new SpeechSynthesisUtterance('Ol√°, eu sou '+name); if(v) u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u)}catch{}}
function msgArch(t,type){archMsg.textContent=t; archMsg.style.display='block'; archMsg.style.background= type==='ok'? '#39ffb6cc' : type==='warn'? '#ffb86bcc' : '#0b1122cc'; archMsg.style.color= type? '#0b0f14':'#eaf0ff'; clearTimeout(archMsg._tm); archMsg._tm=setTimeout(()=>archMsg.style.display='none',3500)}
$("#archPrev").onclick=()=>setArch(archSel.selectedIndex-1);
$("#archNext").onclick=()=>setArch(archSel.selectedIndex+1);
archSel.onchange=()=>setArch(archSel.selectedIndex);
$("#archCircle").onclick=()=>startDual();
$("#archAudio").onclick=()=>startVoice();

// Chat + OpenRouter
const feed=$("#chatFeed");
function push(type,text){const d=document.createElement('div'); d.className='m '+(type==='user'?'u':type==='ai'?'a':''); d.textContent=text; feed.appendChild(d); feed.scrollTop=feed.scrollHeight; if(type==='ai'){const p=$("#preview"); p.textContent=text; if($('#v-home').classList.contains('active')) p.style.display='block'}}
async function sendAI(content,sk,model){const payload={model, messages:[{role:'system',content:'Voc√™ √© o assistente Dual em pt-BR.'},{role:'user',content:String(content)}],max_tokens:220,temperature:.7}; const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+sk},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('API '+r.status); const j=await r.json(); return j?.choices?.[0]?.message?.content||''}
async function handleUserMessage(text){const name=(localStorage.getItem('infodose:userName')||'').trim(); const sk=(localStorage.getItem('dual.keys.openrouter')||'').trim(); const model=LS.get('dual.openrouter.model','openrouter/auto'); if(!sk){msgArch('Configure a chave no Brain.','warn'); return}
push('user','Voc√™: '+text); try{const reply=await sendAI((name?name+': ':'')+text,sk,model); const arch=archSel.options[archSel.selectedIndex]?.textContent||'Dual'; push('ai',arch+': '+reply); speak(reply)}catch(e){push('ai','Desculpe, n√£o consegui responder agora.'); toast('Falha na API','err')}}
function speak(t){try{const vs=speechSynthesis.getVoices(); const v=vs.find(v=>v.lang&&v.lang.startsWith('pt'))||vs[0]; const u=new SpeechSynthesisUtterance(String(t)); if(v) u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u)}catch{}}
function startDual(){msgArch('Oi Dual','ok'); speak('Oi Dual'); setTimeout(()=>startVoice(),500)}
function startVoice(){const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){msgArch('Navegador sem reconhecimento de fala.','warn'); return} const r=new SR(); r.lang='pt-BR'; r.interimResults=false; r.onstart=()=>{push('','üéôÔ∏è Ouvindo‚Ä¶')}; r.onresult=e=>{const t=e.results[0][0].transcript.trim(); if(t) handleUserMessage(t)}; r.onerror=()=>msgArch('Erro no microfone','warn'); r.start()}
$("#btnVoice").onclick=()=>startVoice();
$("#btnText").onclick=()=>{nav('chat'); $("#chatInput").focus()};
$("#chatForm").onsubmit=e=>{e.preventDefault(); const t=$("#chatInput").value.trim(); if(!t) return; $("#chatInput").value=''; handleUserMessage(t)};

// Buttons header
$("#btnBack").onclick=()=>{try{history.length>1&&history.back()}catch{}};
$("#btnDownload").onclick=()=>{const clone=document.documentElement.cloneNode(true); const html='<!doctype html>\n'+clone.outerHTML; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([html],{type:'text/html;charset=utf-8'})); a.download='HUB-UNO.html'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),400); toast('HTML exportado')};
$("#btnHelp").onclick=()=>alert('Atalhos: g+h Home ¬∑ g+a Apps ¬∑ g+s Stack ¬∑ g+b Brain ¬∑ g+c Chat\nCtrl/Cmd+S: baixar HTML');
$("#btnLS").onclick=()=>{nav('brain'); document.getElementById('lsK').focus()};

// Keybinds
let g=false; window.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){e.preventDefault();$("#btnDownload").click()} if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){e.preventDefault();$("#chatInput")?.focus()} if(e.key==='g'){g=true;setTimeout(()=>g=false,600)} if(g){const k=e.key.toLowerCase(); if(k==='h')nav('home'); if(k==='a')nav('apps'); if(k==='s')nav('stack'); if(k==='b')nav('brain'); if(k==='c')nav('chat'); g=false}});

// Init
(function init(){
  applyTheme(); applyCSS(); fillArch(); lsStats();
  // restore last tab
  const last=LS.get('uno:lastTab','home'); nav(last);
  // PWA SW (opcional)
  if(location.protocol==='https:' && 'serviceWorker' in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}))}
})();
</script>
</body></html>
